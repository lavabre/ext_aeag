


<div id="dialog-form" title="Creation d'un nouveau commentaire">
    <form id="form{{ cdEtat }}" action="#" method="post" {{ form_enctype(form) }}>
        {{ form_errors(form) }}

            {{ form_widget(form.euCd) }}
            {{ form_widget(form.cdEtat) }}

            {{ form_widget(form.valeur) }}
            {{ form_errors(form.valeur) }}

            {{ form_errors(form.commentaire) }}
            {{ form_widget(form.commentaire) }}

            <p><h2>{{ form_label(form.valeur, 'Choisir une valeur') }}</h2</p>
            <p></p>
            {%if cdEtat == "GW_CHIMIE_VAL" or cdEtat == "GW_QUANT" or cdEtat == "RW_CHIMIE_VAL"%}
                <p>
                    <span id="{{ cdEtat|e }}_U" p="U" class="dce_etat_U unselected">Inconnu</span>
                    <span id="{{ cdEtat|e }}_2" p="2" class="dce_etat_2 unselected">Bon</span>
                    <span id="{{ cdEtat|e }}_5" p="5" class="dce_etat_5 unselected">Mauvais</span>
                </p>
            {%else%}
                <p>
                <span id="{{ cdEtat|e }}_U" p="U" class="dce_etat_U unselected">Inconnu</span>
                <span id="{{ cdEtat|e }}_1" p="1" class="dce_etat_1 unselected">Trés bon état</span>
                <span id="{{ cdEtat|e }}_2" p="2" class="dce_etat_2 unselected">Bon</span>
                <span id="{{ cdEtat|e }}_3" p="3" class="dce_etat_3 unselected">Moyen</span>
                <span id="{{ cdEtat|e }}_4" p="4" class="dce_etat_4 unselected">Mediocre</span>
                <span id="{{ cdEtat|e }}_5" p="5" class="dce_etat_5 unselected">Mauvais</span>
               </p>
            {%endif%}
            <p><h2>{{ form_label(form.commentaire, 'Saisir un commentaire et éventuellement vos coordonnées') }}</h2></p>
            <p>
                <textarea id="commentaire" cols=60, rows=5 wrap="soft" onkeyup="EnvoyerCommentaire(this)" ></textarea>
            </p>
       
        </form>
    </div>




{% block modal %}
  

            <script type="text/javascript">
          
          
               $('textarea#form_commentaire').hide();
          
              function EnvoyerCommentaire(textarea){
                          if (textarea != '') {
                          $('textarea#form_commentaire').val($(textarea).val());
                          };
                          };
       
           
                
                  $("#dialog-form").hide();  
                
                  $('#dialog-form').modal({
                          title: 'Nouveau commentaire',
                          height:300,
                          width:550,
                          resizable:false,
                          buttons: { 'valider': function(e) { 
                                               //alert($("#form{{ cdEtat }} > #form_valeur").val());
                                               if ( $('textarea#form_commentaire').val() == '' || $("input#form_valeur").val() == '') {
                                                   alert("Choisissez un état et saisissez un commentaire svp");
                                               } else {
                                               // obtenir l'url
                                               var $url = "{{ path('AeagEdlBundle_etatSubmit') }}";
                                               $.getJSON($url,
                                                      {
                                                      euCd: $("input#form_euCd").val(),
                                                      cdEtat: $("input#form_cdEtat").val(),
                                                      commentaire: $("textarea#form_commentaire").val() ,
                                                      valeur: $("input#form_valeur").val()
                                                      }, 

                                                      function(json) {
                                                              //alert(json.message);
                                                              // masquer le div de saisie
                                                              $("#divNewEtat{{ cdEtat }}").hide();
                                                              // charger et afficher les propositions pour cette Etat
                                                              //alert(json.message);
                                                              $("body").css("cursor", "wait");
                                                              $.post("{{ path('AeagEdlBundle_etatListProposed') }}", 
                                                                      { 
                                                                              euCd: "{{ euCd }}", 
                                                                              cdEtat: "{{ cdEtat }}"
                                                                      }, 
                                                                      function(data) {
                                                                              //alert(data);
                                                                              var $div = "#divEtat{{ cdEtat }}";
                                                                              // placer le formulaire sous le div
                                                                              $($div).html(data); 
                                                                              // rétablir curseur
                                                                              $("body").css("cursor", "auto");
                                                                      }
                                                              ).error(function() { 
                                                                      // rétablir curseur
                                                                      $("body").css("cursor", "auto");
                                                                      alert("Erreur non déterminée"); 
                                                              });
                                                          }); 
                                          
                                               e.closeModal();} },
                                     'Annuler': function(e) { 
                                               e.closeModal(); }
                                  }
                  });

           
                 
                   //$("#{{ cdEtat }}_{{ derniereProposition }}").removeClass('unselected');
                   //$("#form{{ cdEtat }} > #form_valeur").val("{{ derniereProposition }}");

                   // choix de la valeur de l etat
                   $("span[id^='{{ cdEtat }}_']").click(function(e){
                           var $newEtat = $(this).attr("p");
                                $("span[id='{{ cdEtat }}_U']").addClass('unselected');
                                $("span[id='{{ cdEtat }}_1']").addClass('unselected');
                                $("span[id='{{ cdEtat }}_2']").addClass('unselected');
                                $("span[id='{{ cdEtat }}_3']").addClass('unselected');
                                $("span[id='{{ cdEtat }}_4']").addClass('unselected');
                                $("span[id='{{ cdEtat }}_5']").addClass('unselected');
                                $("span[id='{{ cdEtat }}_"+$newEtat+"']").removeClass('unselected');
                           // affecter valeur 
                           $("#form{{ cdEtat }} > #form_valeur").val($newEtat);
                   });

            </script>
        

      

{% endblock modal %}